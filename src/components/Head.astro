---
import { siteConfig } from '@/config/site.config'
import type { StructuredData } from '@/types'
import { t } from '@/utils/i18n'
import { buildUrl } from '@/utils/helpers'

interface Props {
  pageTitle: string;
  description?: string;
  ogImage?: string;
  canonicalUrl?: string;
  structuredData?: StructuredData | null;
}

const {
  pageTitle,
  description = siteConfig.description,
  ogImage = '',
  canonicalUrl = Astro.url.href,
  structuredData = null
} = Astro.props as Props
const structuredDataJson = structuredData
  ? JSON.stringify(structuredData).replace(/<\/script/gi, '<\\/script')
  : null

import { ClientRouter } from 'astro:transitions';
---

<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/svg+xml" href={buildUrl('favicon.svg')} />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="generator" content={Astro.generator} />
  <link rel="sitemap" href={buildUrl('sitemap-index.xml')} />

  <title>{pageTitle}</title>
  <meta name="description" content={description} />
  <meta name="keywords" content={siteConfig.keywords.join(', ')} />

  <link rel="canonical" href={canonicalUrl} />

  <meta name="robots" content="index, follow" />
  <meta
    name="googlebot"
    content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
  />

  <meta property="og:title" content={pageTitle} />
  <meta property="og:description" content={description} />
  <meta property="og:type" content="website" />
  <meta property="og:url" content={canonicalUrl} />
  <meta property="og:image" content={ogImage} />
  <meta property="og:site_name" content={siteConfig.name} />
  <meta property="og:locale" content={siteConfig.locale} />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={pageTitle} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={ogImage} />

  <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://*; font-src 'self' data:;" /> -->
  <!-- <meta http-equiv="X-XSS-Protection" content="1; mode=block" /> -->
  <!-- <meta http-equiv="X-Content-Type-Options" content="nosniff" /> -->
  <!-- <meta name="referrer" content="strict-origin-when-cross-origin" /> -->

  <meta
    name="theme-color"
    content={siteConfig.theme.light.primary}
    media="(prefers-color-scheme: light)"
  />
  <meta
    name="theme-color"
    content={siteConfig.theme.dark.primary}
    media="(prefers-color-scheme: dark)"
  />
  {
    structuredDataJson && (
      <script type="application/ld+json" set:html={structuredDataJson} />
    )
  }

  <!-- <link rel="preload" href="/fonts/main-font.woff2" as="font" type="font/woff2" crossorigin /> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono.min.css">
  <script is:inline>
  (function() {
    try {
      const savedTheme = localStorage.getItem('theme')
      const systemPrefersDark = window.matchMedia(
        '(prefers-color-scheme: dark)'
      ).matches
      const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light')

      document.documentElement.classList.add(theme)
      document.documentElement.setAttribute('data-theme', theme)
  } catch (e) {
      console.error('主题设置错误:', e)
  }
  })()
  </script>

  <script is:inline>
    document.addEventListener('astro:before-swap', (event) => {
      try {
        const savedTheme = localStorage.getItem('theme')
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
        const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light')
        const el = event.newDocument && event.newDocument.documentElement
        if (el) {
          el.classList.remove('light', 'dark')
          el.classList.add(theme)
          el.setAttribute('data-theme', theme)
        }
      } catch (e) {
        console.error('Theme Settring err:', e)
      }
    })
  </script>

  <ClientRouter />

  <script is:inline>
  (function() {
    function runPostScripts(root = document) {
      try {
        const container = root.querySelector('.post-content')
        if (!container) return

        // Execute explicit inline scripts
        container
          .querySelectorAll('script[data-astro-exec="inline"]')
          .forEach((s) => {
            try {
              new Function(s.textContent || '')()
            } catch (e) {
              console.error('post inline script error', e)
            }
          })

        // Execute inline module scripts by injecting a module script element
        container
          .querySelectorAll('script[data-astro-exec="module"]:not([src])')
          .forEach((s) => {
            try {
              const el = document.createElement('script')
              el.type = 'module'
              el.textContent = s.textContent || ''
              document.body.appendChild(el)
            } catch (e) {
              console.error('post module inline error', e)
            }
          })

        // Execute module scripts with src by appending a new script element
        container
          .querySelectorAll('script[data-astro-exec="module"][src]')
          .forEach((s) => {
            try {
              const el = document.createElement('script')
              el.type = 'module'
              el.src = s.getAttribute('src') || ''
              el.async = false // preserve execution order
              document.body.appendChild(el)
            } catch (e) {
              console.error('post module src error', e)
            }
          })
      } catch (e) {
        console.error('runPostScripts error', e)
      }
    }

    // Run on SPA page-load (client router)
    document.addEventListener('astro:page-load', () => {
      // small delay to allow swapped content to be inserted
      setTimeout(() => runPostScripts(document), 50)
    })

    // Run once on initial load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () =>
        runPostScripts(document)
      )
    } else {
      runPostScripts(document)
    }
  })()
  </script>
</head>
