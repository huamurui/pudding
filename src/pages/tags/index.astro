---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

type TagPostsMap = Map<string, CollectionEntry<"posts">[]>;

const posts: CollectionEntry<"posts">[] = await getCollection("posts");
const tagsPosts: TagPostsMap = new Map();

// 按标签分组文章，并按时间排序（最新在前）
for (const post of posts) {
  for (const tag of post.data.tags || []) {
    const existingPosts = tagsPosts.get(tag) || [];
    // 添加并按日期排序
    const updatedPosts = [...existingPosts, post].sort(
      (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
    );
    tagsPosts.set(tag, updatedPosts);
  }
}

// 按标签名称排序
const sortedTags = Array.from(tagsPosts.keys()).sort((a, b) =>
  a.localeCompare(b),
);
---

<BaseLayout pageTitle="Tags">
  <div class="tags-page">
    <!-- 页面标题 -->
    <header class="page-header">
      <h1>Tags</h1>
    </header>

    <!-- 标签导航栏 - 可点击跳转到对应标签 -->
    <div class="tags-nav">
      <!-- 小屏幕折叠按钮 -->
      <button class="tags-toggle" aria-label="切换标签显示">
        标签 <span class="toggle-icon">▼</span>
      </button>
      
      <div class="tags-container">
        {sortedTags.map((tag) => (
          <a 
            href={`#tag-${tag}`} 
            class="post-tag"
            data-tag={tag}
          >
            {tag}
            <span class="tag-count">
              {tagsPosts.get(tag)?.length || 0}
            </span>
          </a>
        ))}
      </div>
    </div>

    <!-- 主内容区 - 时间线布局 -->
    <div class="timeline-container">
      {sortedTags.map((tag) => {
        const tagPosts = tagsPosts.get(tag);
        if (!tagPosts || tagPosts.length === 0) return null;

        return (
          <section id={`tag-${tag}`} class="tag-section" >
            <!-- 标签标题 - 带时间线指示器 -->
            <div class="tag-section-header">
              <h3 class="tag-title">
                {tag}
                <span class="post-count">
                  {tagPosts.length} 篇文章
                </span>
              </h3>
            </div>

            <!-- 文章列表 - 时间线样式 -->
            <div class="tag-posts">
              {tagPosts.map((post, index) => (
                <article class="timeline-post" >
                  <!-- 文章内容 -->
                  <div class="post-content">                    
                    <div class="post-info">
                      <!-- 日期（最左侧） -->
                      <time class="post-date">
                        {new Date(post.data.date).toLocaleDateString('zh-CN', {
                          month: '2-digit',
                          day: '2-digit'
                        })}
                      </time>
                      <div class="timeline-connector">
                        <div class="post-marker"></div>
                      </div>
                      
                      <!-- 标题 -->
                      <a href={`/posts/${post.id}`} class="post-link">
                        <h4 class="post-title">{post.data.title}</h4>
                      </a>
                      
                      <!-- 标签 -->
                      <div class="post-tags">
                        {post.data.tags?.map((t) => (
                          <a href={`/tags/${t}`} class="inline-tag" key={t}>
                            #{t}
                          </a>
                        ))}
                      </div>
                    </div>
                  </div>
                </article>
              ))}
            </div>
          </section>
        );
      })}
    </div>
  </div>

  <!-- 标签导航交互脚本 -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tagSections = document.querySelectorAll('.tag-section');
      const navItems = document.querySelectorAll('.post-tag');
      const tagsContainer = document.querySelector('.tags-container');
      const tagsToggle = document.querySelector('.tags-toggle');
      const toggleIcon = document.querySelector('.toggle-icon');
      
      // 折叠/展开标签导航
      if (tagsToggle && tagsContainer && toggleIcon) {
        tagsToggle.addEventListener('click', () => {
          tagsContainer.classList.toggle('expanded');
          toggleIcon.textContent = tagsContainer.classList.contains('expanded') ? '▲' : '▼';
        });
      }
      
      // 滚动时高亮当前标签
      const handleScroll = () => {
        const scrollPosition = window.scrollY + 100;
        
        let activeTag = '';
        tagSections.forEach(section => {
          const sectionTop = section.offsetTop;
          const sectionId = section.id;
          
          if (scrollPosition >= sectionTop) {
            activeTag = sectionId.replace('tag-', '');
          }
        });
        
        navItems.forEach(item => {
          if (item.getAttribute('data-tag') === activeTag) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });
      };
      
      window.addEventListener('scroll', handleScroll);
      handleScroll();
      
      // 标签点击平滑滚动
      document.querySelectorAll('.post-tag').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = link.getAttribute('href');
          const targetElement = document.querySelector(targetId);
          
          if (targetElement) {
            window.scrollTo({
              top: targetElement.offsetTop - 80,
              behavior: 'smooth'
            });
            
            // 小屏幕点击后自动折叠导航
            if (window.innerWidth <= 600 && tagsContainer) {
              tagsContainer.classList.remove('expanded');
              if (toggleIcon) toggleIcon.textContent = '▼';
            }
          }
        });
      });
    });
  </script>
</BaseLayout>

<style>
  /* 页面基础样式 */
  .tags-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 32px 16px;
  }

  /* 页面标题 */
  .page-header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-color);
  }

  .page-header h1 {
    font-size: 35px;
    color: var(--text-primary);
    margin: 0 0 12px 0;
  }

  /* 标签导航栏 */
  .tags-nav {
    margin: 0 0 40px 0;
    position: sticky;
    top: 64px;
    z-index: 10;
    background-color: var(--bg-primary);
    padding: 8px 0;
    border-radius: 8px;
    box-shadow: 0 2px 4px var(--shadow);
  }

  /* 标签折叠按钮 - 默认隐藏 */
  .tags-toggle {
    display: none;
    width: 100%;
    padding: 8px 16px;
    background-color: var(--bg-secondary);
    border: none;
    color: var(--text-primary);
    font-size: 14px;
    cursor: pointer;
    text-align: left;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .toggle-icon {
    font-size: 12px;
  }

  .tags-container {
    display: flex;
    gap: 12px;
    padding: 8px 16px;
    overflow-x: auto;
    flex-wrap: wrap;
    scrollbar-width: thin;
  }



  .tag-count {
    background-color: var(--bg-tertiary);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 1px 8px;
    border-radius: 10px;
  }

  /* 时间线容器 */
  .timeline-container {
    position: relative;
    padding-left: 0;
  }

  /* 标签区块 */
  .tag-section {
    margin-bottom: 48px;
    padding-top: 8px;
  }

  .tag-section-header {
    position: relative;
    padding-bottom: 8px;
  }

  .tag-title {
    font-size: 24px;
    color: var(--text-primary);
    margin: 0;
    display: inline-flex;
    align-items: center;
    gap: 12px;
  }

  .tag-title .post-count {
    font-size: 13px;
    font-weight: normal;
    color: var(--text-secondary);
    background-color: var(--bg-tertiary);
    padding: 3px 10px;
    border-radius: 12px;
  }

  /* 文章时间线样式 */
  .tag-posts {
    position: relative;
  }

  .timeline-post {
    position: relative;
    padding: 8px 0;
  }

  /* 时间点标记 */
  .post-marker {
    position: relative;
    width: 6px;
    height: 6px;
    border-radius: 6px;
    background-color: var(--text-secondary);
    z-index: 2;
    transition: background-color 0.2s ease, height 0.2s ease;
  }

  .post-info:hover .post-marker {
    height: 20px;
  }

  .timeline-container {
    position: relative;
    height: 100%;
  }

  .timeline-connector::before {
    content: "";
    position: absolute;
    width: 10%;
    height: 100%;
    left: calc(50% - 1px);
    border-left: 2px dashed var(--line-color);
    pointer-events: none;
    transition: all .3s;
    transform: translateY(-50%);
  }

  /* 文章内容 */
  .post-content {
    position: relative;
  }

  .post-info {
    display: flex;
    align-items: center;
    gap: 24px;
    height: 100%;
    width: 100%;
    padding: 8px 4px;
    flex-wrap: wrap;
    border-radius: 8px;
    transition: background-color 0.2s ease;
  }
  
  .post-info:hover {
    background-color: color-mix(in srgb, var(--theme-color) 10%, transparent);
  }
  
  .post-info:hover .post-marker {
    background-color: var(--theme-color);
  }

  /* 日期样式 */
  .post-date {
    font-size: 14px;
    color: var(--text-secondary);
    width: 60px;
    text-align: right;
    white-space: nowrap;
  }

  .post-link {
    text-decoration: none;
    flex: 1;
    min-width: 200px;
  }

  .post-title {
    font-size: 18px;
    color: var(--text-primary);
    margin: 0;
    transition: color 0.2s ease;
  }

  .post-info:hover .post-title {
    color: var(--theme-color);
  }

  /* 标签样式 */


  /* 响应式调整 - 小屏幕标签折叠 */
  @media (max-width: 600px) {
    /* 显示折叠按钮 */
    .tags-toggle {
      display: flex;
    }
    
    /* 默认隐藏标签容器 */
    .tags-container {
      display: none;
      padding: 8px 16px;
      max-height: 200px;
      overflow-y: auto;
      flex-direction: column;
      gap: 8px;
    }
    
    /* 展开状态 */
    .tags-container.expanded {
      display: flex;
    }
    
    .post-tags {
      display: none;
    }
  }
</style>