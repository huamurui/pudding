---
import { type CollectionEntry, getCollection } from "astro:content";
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostList from '../../components/PostList/PostList';

// 定义文章数据转换后的类型
interface PostListItem {
  id: string;
  title: string;
  date: string | Date;
  description?: string;
  tags: string[];
  url: string;
}

// 定义getStaticPaths返回类型
type StaticPath = {
  params: {
    tag: string;
  };
  props: {
    tag: string;
    posts: CollectionEntry<'posts'>[];
  };
};

export async function getStaticPaths(): Promise<StaticPath[]> {
  const posts = await getCollection("posts");
  const tags = new Map<string, CollectionEntry<'posts'>[]>();

  for (const post of posts) {
    for (const tag of post.data.tags || []) {
      if (!tags.has(tag)) {
        tags.set(tag, []);
      }
      tags.get(tag)!.push(post);
    }
  }

  return Array.from(tags.entries()).map(([tag, posts]): StaticPath => ({
    params: { tag },
    props: { tag, posts },
  }));
}

// 定义页面属性类型
interface Props {
  tag: string;
  posts: CollectionEntry<'posts'>[];
}

const { tag, posts } = Astro.props as Props;
---

<BaseLayout title={`Tag ⬝ ${tag}`} description={`Posts tagged with ${tag}`}>
  <div class="tag">
    <div class="stat">
      <div class="stat-title">
        <h1>{tag}</h1>
      </div>
      <div class="stat-desc">
        <span>Total posts: {posts.length}</span>
      </div>
    </div>
  </div>
  <PostList 
    posts={() => posts.map(post => ({
      id: post.id,
      title: post.data.title,
      date: post.data.date,
      description: post.data.description,
      tags: post.data.tags || [],
      url: `/posts/${post.id}/`,
    })) as PostListItem[]}
  />
</BaseLayout>
