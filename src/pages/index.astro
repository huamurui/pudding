---
import BaseLayout from '../layouts/BaseLayout.astro';
import PostCardList from '../components/PostCardList/PostCardList';
import { getCollection, render } from 'astro:content';
import { siteConfig } from '../config/site.config';
import { extractExcerptFromHtml, getPostUrl } from '../utils/helpers';
import { generatePostListStructuredData } from '../utils/structured-data';
import { ANIMATION_DURATION, EASING } from '../utils/constants';
import type { PostData, StructuredData } from '../types';
import { experimental_AstroContainer } from "astro/container";
const container = await experimental_AstroContainer.create();

const _posts = await getCollection('posts');
const postsWithExcerpt: PostData[] = await Promise.all(
  _posts.map(async (post) => {
    const { Content } = await render(post);
    const html = await container.renderToString(Content);
    
    return {
      id: post.id,
      title: post.data.title,
      date: post.data.date,
      tags: post.data.tags || [],
      url: getPostUrl(post.id),
      excerptHtml: extractExcerptFromHtml(html)
    };
  })
);

// 排序并生成 ItemList 结构化数据
const sortedPosts = postsWithExcerpt.slice().sort(
  (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
);
const posts = () => sortedPosts;

const structuredData = generatePostListStructuredData(
  sortedPosts.map(p => ({ title: p.title, url: p.url })),
  Astro.url.origin
);

// custom title morph animation used for list <-> post transitions
const anim = {
  old: { name: "title-old", duration: ANIMATION_DURATION.slow, easing: EASING.smooth, fillMode: "both" },
  new: { name: "title-new", duration: ANIMATION_DURATION.slow, easing: EASING.smooth, fillMode: "both" },
};
const customTransition = { forwards: anim, backwards: anim };
---
<BaseLayout structuredData={structuredData}>
  <div style={{
    maxWidth: '800px',
    margin: '0 auto',
    padding: '2rem 1rem',
  }}>
    <PostCardList posts={posts} transition={customTransition} />
  </div>
</BaseLayout>
