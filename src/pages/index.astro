---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostCardList from '@/components/PostCardList/PostCardList.svelte';
import { getCollection, render } from 'astro:content';
import { siteConfig } from '@/config/site.config';
import { extractExcerptFromHtml, getPostUrl } from '@/utils/helpers';
import { generatePostListStructuredData } from '@/utils/structured-data';
import { ANIMATION_DURATION, EASING } from '@/utils/constants';
import type { PostData, StructuredData } from '@/types';
import { experimental_AstroContainer } from "astro/container";
const container = await experimental_AstroContainer.create();

const _posts = await getCollection('posts');
const postsWithExcerpt: PostData[] = await Promise.all(
  _posts.map(async (post) => {
    const { Content } = await render(post);
    const html = await container.renderToString(Content);
    
    return {
      id: post.id,
      title: post.data.title,
      date: post.data.date,
      tags: post.data.tags || [],
      url: getPostUrl(post.id),
      excerptHtml: extractExcerptFromHtml(html),
      pinned: post.data.pinned || false
    };
  })
);

const sortedPosts = postsWithExcerpt.slice().sort(
  (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
);
const posts = sortedPosts;

const structuredData = generatePostListStructuredData(
  sortedPosts.map(p => ({ title: p.title, url: p.url })),
  Astro.url.origin
);

---
<BaseLayout structuredData={structuredData}>
  <div style={{
    maxWidth: '800px',
    margin: '0 auto',
    padding: '2rem 1rem',
  }}>
    <PostCardList posts={posts} />
  </div>
</BaseLayout>
